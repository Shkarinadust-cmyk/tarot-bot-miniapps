import os
import random
import requests
import json
from typing import List, Tuple

class TarotLogic:
    def __init__(self):
        self.api_key = os.getenv('DEEPSEEK_API_KEY')
        self.base_url = "https://api.deepseek.com/v1/chat/completions"
        
        # –ü–æ–ª–Ω–∞—è –∫–æ–ª–æ–¥–∞ –¢–∞—Ä–æ (78 –∫–∞—Ä—Ç)
        self.major_arcana = {
            "0. –®—É—Ç": {
                "meaning": "–ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ –ø—É—Ç–∏, –Ω–µ–≤–∏–Ω–Ω–æ—Å—Ç—å, —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ—Å—Ç—å, —Å–≤–æ–±–æ–¥–∞, –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è",
                "reversed": "–ë–µ–∑—Ä–∞—Å—Å—É–¥—Å—Ç–≤–æ, —Ä–∏—Å–∫, –Ω–µ–∑—Ä–µ–ª–æ—Å—Ç—å, –∑–∞–¥–µ—Ä–∂–∫–∏, –Ω–µ–æ–±–¥—É–º–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è"
            },
            "1. –ú–∞–≥": {
                "meaning": "–í–æ–ª—è, –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è, —Å–∏–ª–∞ –≤–æ–ª–∏, –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–π",
                "reversed": "–ú–∞–Ω–∏–ø—É–ª—è—Ü–∏—è, —Å–ª–∞–±–∞—è –≤–æ–ª—è, –æ–±–º–∞–Ω, –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–ª–∞–Ω—Ç—ã"
            },
            "2. –í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞": {
                "meaning": "–ò–Ω—Ç—É–∏—Ü–∏—è, —Ç–∞–π–Ω—ã, –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –∑–Ω–∞–Ω–∏–µ, –º—É–¥—Ä–æ—Å—Ç—å",
                "reversed": "–°–∫—Ä—ã—Ç—ã–µ –º–æ—Ç–∏–≤—ã, –ø–æ–¥–∞–≤–ª–µ–Ω–Ω–∞—è –∏–Ω—Ç—É–∏—Ü–∏—è, —Å–µ–∫—Ä–µ—Ç—ã, –Ω–µ–≤–µ–∂–µ—Å—Ç–≤–æ"
            },
            "3. –ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞": {
                "meaning": "–ò–∑–æ–±–∏–ª–∏–µ, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ, –ø—Ä–∏—Ä–æ–¥–∞, –ø–ª–æ–¥–æ—Ä–æ–¥–∏–µ, –∫—Ä–∞—Å–æ—Ç–∞, –≥–∞—Ä–º–æ–Ω–∏—è",
                "reversed": "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, —Ä–∞—Å—Ç–æ—á–∏—Ç–µ–ª—å—Å—Ç–≤–æ, –±–µ—Å–ø–ª–æ–¥–∏–µ, —Ç–≤–æ—Ä—á–µ—Å–∫–∏–π –±–ª–æ–∫"
            },
            "4. –ò–º–ø–µ—Ä–∞—Ç–æ—Ä": {
                "meaning": "–í–ª–∞—Å—Ç—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –∫–æ–Ω—Ç—Ä–æ–ª—å, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç, –ø–æ—Ä—è–¥–æ–∫",
                "reversed": "–¢–∏—Ä–∞–Ω–∏—è, –∂–µ—Å—Ç–∫–æ—Å—Ç—å, —Å–ª–∞–±–æ—Å—Ç—å, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã"
            }
        }
        
        self.minor_arcana = {
            "–ñ–µ–∑–ª—ã": {
                "–¢—É–∑": {"meaning": "–ù–æ–≤—ã–µ –Ω–∞—á–∏–Ω–∞–Ω–∏—è, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ, —ç–Ω–µ—Ä–≥–∏—è", "reversed": "–ó–∞–¥–µ—Ä–∂–∫–∏, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —ç–Ω—Ç—É–∑–∏–∞–∑–º–∞"},
                "2": {"meaning": "–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –±—É–¥—É—â–∏–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã", "reversed": "–°—Ç—Ä–∞—Ö–∏, –Ω–µ—Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"},
                "3": {"meaning": "–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ, —Ä–æ—Å—Ç, –ø—Ä–æ–≥—Ä–µ—Å—Å", "reversed": "–ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è, –∑–∞–¥–µ—Ä–∂–∫–∏"},
                "4": {"meaning": "–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –æ—Å–Ω–æ–≤–∞", "reversed": "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –∂–µ—Å—Ç–∫–æ—Å—Ç—å"},
                "5": {"meaning": "–ö–æ–Ω—Ñ–ª–∏–∫—Ç, –≤—ã–∑–æ–≤, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è", "reversed": "–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞, –ø–µ—Ä–µ–º–∏—Ä–∏–µ"},
                "6": {"meaning": "–ü–æ–±–µ–¥–∞, —É—Å–ø–µ—Ö, –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ", "reversed": "–≠–≥–æ–∏–∑–º, –ø–∞–¥–µ–Ω–∏–µ —Å –≤—ã—Å–æ—Ç—ã"},
                "7": {"meaning": "–ó–∞—â–∏—Ç–∞, –Ω–∞—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, –≤—ã–∑–æ–≤", "reversed": "–°–æ–º–Ω–µ–Ω–∏—è, —É—è–∑–≤–∏–º–æ—Å—Ç—å"},
                "8": {"meaning": "–°–∫–æ—Ä–æ—Å—Ç—å, –¥–µ–π—Å—Ç–≤–∏–µ, –ø—Ä–æ–≥—Ä–µ—Å—Å", "reversed": "–ó–∞–¥–µ—Ä–∂–∫–∏, —Å–ø–µ—à–∫–∞"},
                "9": {"meaning": "–°–∏–ª–∞, —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å, –∑–∞—â–∏—Ç–∞", "reversed": "–£–ø—Ä—è–º—Å—Ç–≤–æ, —Å–ª–∞–±–æ—Å—Ç—å"},
                "10": {"meaning": "–ë—Ä–µ–º—è, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –Ω–∞–≥—Ä—É–∑–∫–∞", "reversed": "–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ, –æ–±–ª–µ–≥—á–µ–Ω–∏–µ"}
            },
            "–ö—É–±–∫–∏": {
                "–¢—É–∑": {"meaning": "–ù–æ–≤—ã–µ —á—É–≤—Å—Ç–≤–∞, –ª—é–±–æ–≤—å, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞—á–∞–ª–æ", "reversed": "–ü—É—Å—Ç–æ—Ç–∞, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞"},
                "2": {"meaning": "–ü–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ, —Å–æ—é–∑, –≥–∞—Ä–º–æ–Ω–∏—è", "reversed": "–î–∏—Å–±–∞–ª–∞–Ω—Å, —Ä–∞–∑—Ä—ã–≤"},
                "3": {"meaning": "–ü—Ä–∞–∑–¥–Ω–∏–∫, —Ä–∞–¥–æ—Å—Ç—å, –¥—Ä—É–∂–±–∞", "reversed": "–ß—Ä–µ–∑–º–µ—Ä–Ω–æ–µ –≤–µ—Å–µ–ª—å–µ, –∏–∑–ª–∏—à–µ—Å—Ç–≤–∞"},
                "4": {"meaning": "–°–æ–∑–µ—Ä—Ü–∞–Ω–∏–µ, –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "reversed": "–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –ø—Ä–∏–Ω—è—Ç–∏–µ"},
                "5": {"meaning": "–ü–æ—Ç–µ—Ä—è, —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ, –≥–æ—Ä–µ", "reversed": "–ü—Ä–∏–º–∏—Ä–µ–Ω–∏–µ, –∏—Å—Ü–µ–ª–µ–Ω–∏–µ"},
                "6": {"meaning": "–ù–æ—Å—Ç–∞–ª—å–≥–∏—è, –¥–µ—Ç—Å—Ç–≤–æ, –Ω–µ–≤–∏–Ω–Ω–æ—Å—Ç—å", "reversed": "–ñ–∏–≤—è –ø—Ä–æ—à–ª—ã–º, –æ—Ç–∫–∞–∑ —Ä–∞—Å—Ç–∏"},
                "7": {"meaning": "–í—ã–±–æ—Ä, –∏–ª–ª—é–∑–∏–∏, –º–µ—á—Ç—ã", "reversed": "–Ø—Å–Ω–æ—Å—Ç—å, –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π"},
                "8": {"meaning": "–£—Ö–æ–¥, –¥–≤–∏–∂–µ–Ω–∏–µ –≤–ø–µ—Ä–µ–¥", "reversed": "–ó–∞—Å—Ç–æ–π, —Å—Ç—Ä–∞—Ö –ø–µ—Ä–µ–º–µ–Ω"},
                "9": {"meaning": "–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∂–µ–ª–∞–Ω–∏–π, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ", "reversed": "–ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å, –∏–∑–ª–∏—à–µ—Å—Ç–≤–∞"},
                "10": {"meaning": "–°—á–∞—Å—Ç—å–µ, –≥–∞—Ä–º–æ–Ω–∏—è, —Å–µ–º–µ–π–Ω–æ–µ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–µ", "reversed": "–°–µ–º–µ–π–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, —Ä–∞–∑–ª–∞–¥"}
            },
            "–ú–µ—á–∏": {
                "–¢—É–∑": {"meaning": "–ü—Ä–æ—Ä—ã–≤, —è—Å–Ω–æ—Å—Ç—å, –ø–æ–±–µ–¥–∞", "reversed": "–ü—É—Ç–∞–Ω–∏—Ü–∞, —Ö–∞–æ—Å, –∂–µ—Å—Ç–æ–∫–æ—Å—Ç—å"},
                "2": {"meaning": "–¢—É–ø–∏–∫, –≤—ã–±–æ—Ä, –±–∞–ª–∞–Ω—Å", "reversed": "–ù–µ—Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è"},
                "3": {"meaning": "–°–µ—Ä–¥–µ—á–Ω–∞—è –±–æ–ª—å, —Ä–∞–∑—Ä—ã–≤, –ø–µ—á–∞–ª—å", "reversed": "–ò—Å—Ü–µ–ª–µ–Ω–∏–µ, –ø—Ä–æ—â–µ–Ω–∏–µ"},
                "4": {"meaning": "–û—Ç–¥—ã—Ö, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, —É–µ–¥–∏–Ω–µ–Ω–∏–µ", "reversed": "–ò–∑–æ–ª—è—Ü–∏—è, –∏—Å—Ç–æ—â–µ–Ω–∏–µ"},
                "5": {"meaning": "–ü–æ—Ä–∞–∂–µ–Ω–∏–µ, –ø—Ä–µ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ, –Ω–µ—É–¥–∞—á–∞", "reversed": "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —É—Ä–æ–∫–æ–≤"},
                "6": {"meaning": "–ü–µ—Ä–µ—Ö–æ–¥, –¥–≤–∏–∂–µ–Ω–∏–µ, –ø—Ä–æ–≥—Ä–µ—Å—Å", "reversed": "–¢—É–ø–∏–∫, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞"},
                "7": {"meaning": "–û–±–º–∞–Ω, —Ö–∏—Ç—Ä–æ—Å—Ç—å, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è", "reversed": "–†–∞—Å–∫—Ä—ã—Ç–∏–µ –æ–±–º–∞–Ω–∞, –ø—Ä–∞–≤–¥–∞"},
                "8": {"meaning": "–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –ª–æ–≤—É—à–∫–∞, –∂–µ—Ä—Ç–≤–∞", "reversed": "–û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ, –Ω–æ–≤—ã–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã"},
                "9": {"meaning": "–¢—Ä–µ–≤–æ–≥–∞, –∫–æ—à–º–∞—Ä—ã, –±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ", "reversed": "–ù–∞–¥–µ–∂–¥–∞, –æ–±–ª–µ–≥—á–µ–Ω–∏–µ"},
                "10": {"meaning": "–ö–æ–Ω–µ—Ü, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ, –ø–æ—Ä–∞–∂–µ–Ω–∏–µ", "reversed": "–í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ, –Ω–æ–≤–∞—è –Ω–∞–¥–µ–∂–¥–∞"}
            },
            "–ü–µ–Ω—Ç–∞–∫–ª–∏": {
                "–¢—É–∑": {"meaning": "–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –±–æ–≥–∞—Ç—Å—Ç–≤–æ, –∏–∑–æ–±–∏–ª–∏–µ", "reversed": "–£–ø—É—â–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏"},
                "2": {"meaning": "–ë–∞–ª–∞–Ω—Å, –∞–¥–∞–ø—Ç–∞—Ü–∏—è, –ø–∞—Ä—Ç–Ω–µ—Ä—Å—Ç–≤–æ", "reversed": "–î–∏—Å–±–∞–ª–∞–Ω—Å, –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å"},
                "3": {"meaning": "–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ, —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ, —Ä–æ—Å—Ç", "reversed": "–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞, –Ω–µ–∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å"},
                "4": {"meaning": "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –∫–æ–Ω—Ç—Ä–æ–ª—å", "reversed": "–†–∞—Å—Ç–æ—á–∏—Ç–µ–ª—å—Å—Ç–≤–æ, –∂–∞–¥–Ω–æ—Å—Ç—å"},
                "5": {"meaning": "–¢—Ä—É–¥–Ω–æ—Å—Ç–∏, –ø–æ—Ç–µ—Ä–∏, –±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ", "reversed": "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, –ø—Ä–µ–æ–¥–æ–ª–µ–Ω–∏–µ"},
                "6": {"meaning": "–©–µ–¥—Ä–æ—Å—Ç—å, –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –ø–æ–º–æ—â—å", "reversed": "–≠–≥–æ–∏–∑–º, –¥–æ–ª–≥–∏"},
                "7": {"meaning": "–¢–µ—Ä–ø–µ–Ω–∏–µ, –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã, —Ä–æ—Å—Ç", "reversed": "–ù–µ—Ç–µ—Ä–ø–µ–Ω–∏–µ, –Ω–µ—É–¥–∞—á–∏"},
                "8": {"meaning": "–†–µ–º–µ—Å–ª–æ, –æ–±—É—á–µ–Ω–∏–µ, –Ω–∞–≤—ã–∫–∏", "reversed": "–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–º–±–∏—Ü–∏–π, –Ω–µ–∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å"},
                "9": {"meaning": "–ò–∑–æ–±–∏–ª–∏–µ, –∫–æ–º—Ñ–æ—Ä—Ç, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å", "reversed": "–ë–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ, –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã"},
                "10": {"meaning": "–ù–∞—Å–ª–µ–¥–∏–µ, —Å–µ–º—å—è, —Ç—Ä–∞–¥–∏—Ü–∏–∏", "reversed": "–°–µ–º–µ–π–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã"}
            }
        }

    def draw_random_card(self) -> Tuple[str, dict, bool]:
        """–í—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ä—Ç—É –∏ –µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ"""
        is_major = random.random() < 0.4  # 40% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å—Ç–∞—Ä—à–µ–≥–æ –∞—Ä–∫–∞–Ω–∞
        
        if is_major:
            card_name = random.choice(list(self.major_arcana.keys()))
            meaning = self.major_arcana[card_name]
        else:
            suit = random.choice(list(self.minor_arcana.keys()))
            card_number = random.choice(list(self.minor_arcana[suit].keys()))
            card_name = f"{card_number} {suit}"
            meaning = self.minor_arcana[suit][card_number]
        
        is_reversed = random.random() < 0.3  # 30% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–æ–π –∫–∞—Ä—Ç—ã
        
        return card_name, meaning, is_reversed

    async def generate_tarot_response(self, question: str) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å –ø–æ–º–æ—â—å—é DeepSeek API"""
        
        # –°–Ω–∞—á–∞–ª–∞ –¥–µ–ª–∞–µ–º —Ä–∞—Å–∫–ª–∞–¥
        card_name, meaning, is_reversed = self.draw_random_card()
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò
        prompt = f"""
–¢—ã - –º—É–¥—Ä—ã–π —Ç–∞—Ä–æ–ª–æ–≥ –°–ø—É—Ç–Ω–∏–∫, –æ–ø—ã—Ç–Ω—ã–π –≤ –∏—Å–∫—É—Å—Å—Ç–≤–µ –¢–∞—Ä–æ —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. 
–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ª—é–¥—è–º –Ω–∞–π—Ç–∏ —è—Å–Ω–æ—Å—Ç—å –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–∞—Ä—Ç—ã. –¢–≤–æ–π —Ç–æ–Ω - —Å–ø–æ–∫–æ–π–Ω—ã–π, –º—É–¥—Ä—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π, —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –º–∞–≥–∏–∏.

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "{question}"

–í—ã–ø–∞–≤—à–∞—è –∫–∞—Ä—Ç–∞: {card_name}
–ü–æ–ª–æ–∂–µ–Ω–∏–µ: {'–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–æ–µ' if is_reversed else '–ü—Ä—è–º–æ–µ'}
–û—Å–Ω–æ–≤–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: {meaning['reversed'] if is_reversed else meaning['meaning']}

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
1. –ö—Ä–∞—Ç–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)
2. –û–±—ä—è—Å–Ω–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. –î–∞–π –º—É–¥—Ä—ã–π —Å–æ–≤–µ—Ç –∏–ª–∏ –≤—ã–≤–æ–¥
4. –ë—É–¥—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º, —Ç–µ–ø–ª—ã–º –∏ –Ω–µ–º–Ω–æ–≥–æ –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–º
5. –ò—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ –∏ –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤
6. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 6-8 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
7. –ù–∞–ø–æ–º–Ω–∏, —á—Ç–æ –¢–∞—Ä–æ - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è, –∞ –Ω–µ —Å—Ç—Ä–æ–≥–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ

–í–∞–∂–Ω–æ: –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤–æ–ø—Ä–æ—Å–∞, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–π –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è –ª–∏—á–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏.
"""

        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {self.api_key}"
        }

        data = {
            "model": "deepseek-chat",
            "messages": [
                {
                    "role": "system",
                    "content": """–¢—ã - –º—É–¥—Ä—ã–π —Ç–∞—Ä–æ–ª–æ–≥ –°–ø—É—Ç–Ω–∏–∫ —Å –≥–ª—É–±–æ–∫–∏–º –∑–Ω–∞–Ω–∏–µ–º –∫–∞—Ä—Ç –¢–∞—Ä–æ. 
–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ª—é–¥—è–º –Ω–∞–π—Ç–∏ —è—Å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –∫–∞—Ä—Ç—ã. –¢—ã —Å–ø–æ–∫–æ–µ–Ω, –º—É–¥—Ä, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å –∏ –¥–∞–µ—à—å –Ω–∞–¥–µ–∂–¥—É. 
–¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –º–µ—Ç–∞—Ñ–æ—Ä—ã –∏ –æ–±—Ä–∞–∑—ã, –æ–±—ä—è—Å–Ω—è–µ—à—å –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞—Ä—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤–æ–ø—Ä–æ—Å–∞ —á–µ–ª–æ–≤–µ–∫–∞.
–¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –≤—Å–µ–≥–¥–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç: –ø–æ–Ω–∏–º–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞, –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã, –º—É–¥—Ä—ã–π —Å–æ–≤–µ—Ç.
–¢—ã –ø–∏—à–µ—à—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Å–º–∞–π–ª–∏–∫–∏ –∏ –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤.
–¢—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—É–≥–∞–µ—à—å –∏ –Ω–µ –¥–∞–µ—à—å –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π, –∞ –≤—Å–µ–≥–¥–∞ –Ω–∞—Ö–æ–¥–∏—à—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Ä–æ—Å—Ç–∞."""
                },
                {
                    "role": "user",
                    "content": prompt
                }
            ],
            "temperature": 0.7,
            "max_tokens": 800
        }

        try:
            response = requests.post(self.base_url, headers=headers, json=data, timeout=30)
            response.raise_for_status()
            
            result = response.json()
            ai_response = result['choices'][0]['message']['content']
            
            return self.format_response(ai_response, card_name, is_reversed)
            
        except Exception as e:
            # Fallback –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
            return self.generate_fallback_response(question, card_name, meaning, is_reversed)

    def format_response(self, response: str, card: str, is_reversed: bool) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ò–ò"""
        position = "üîª –ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞—è" if is_reversed else "üî∫ –ü—Ä—è–º–∞—è"
        
        formatted_response = f"""
*‚ú® –í–´–ü–ê–õ–ê –ö–ê–†–¢–ê: {card.upper()} ‚ú®*

*{position}*

{response}

*üí´ –ù—É–∂–µ–Ω –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–∏–π —Ä–∞—Å–∫–ª–∞–¥? –°–ø—Ä–æ—Å–∏ –º–µ–Ω—è –æ –¥–µ—Ç–∞–ª—è—Ö!*
"""
        return formatted_response

    def generate_fallback_response(self, question: str, card: str, meaning: dict, is_reversed: bool) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ –ò–ò –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω"""
        position = "–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–æ–º" if is_reversed else "–ø—Ä—è–º–æ–º"
        main_meaning = meaning['reversed'] if is_reversed else meaning['meaning']
        
        return f"""
*‚ú® –ö–ê–†–¢–´ –ì–û–í–û–†–Ø–¢... ‚ú®*

–¢–≤–æ–π –≤–æ–ø—Ä–æ—Å –æ *"{question}"* –Ω–∞—à–µ–ª –æ—Ç–∫–ª–∏–∫!

*–í—ã–ø–∞–ª–∞ –∫–∞—Ä—Ç–∞: {card.upper()}*
–í *{position}* –ø–æ–ª–æ–∂–µ–Ω–∏–∏

**–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç?**
{main_meaning}

**–ú–æ–π —Å–æ–≤–µ—Ç —Ç–µ–±–µ:**
–ü—Ä–∏—Å–ª—É—à–∞–π—Å—è –∫ —Å–≤–æ–µ–π –∏–Ω—Ç—É–∏—Ü–∏–∏ –≤ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ üåô
–ö–∞—Ä—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ —Å–µ–π—á–∞—Å –≤—Ä–µ–º—è –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ä–æ—Å—Ç–∞.

*–ü–æ–º–Ω–∏:* –¢–∞—Ä–æ - —ç—Ç–æ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫ –¥–ª—è —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏—è, –∞ –Ω–µ –ø—Ä–∏–≥–æ–≤–æ—Ä! 
–¢—ã –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—à—å —Å–≤–æ–±–æ–¥—É –≤—ã–±–æ—Ä–∞ –∏ –º–æ–∂–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–π –ø—É—Ç—å üí´

*–•–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ? –ó–∞–¥–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å!* üîÆ
"""

# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
tarot_logic = TarotLogic()